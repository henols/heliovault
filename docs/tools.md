# Tools Guide

This document lists the project tools, what they do, and how to run them.

---

## tools/tasks/watch_assets.py

Watches `.tset` and `.lvl` files and rebuilds outputs when they change.

Usage:
```
python tools/tasks/watch_assets.py --levels levels --tset levels/tileset.tset
python tools/tasks/watch_assets.py --once
python tools/tasks/watch_assets.py /path/to/project
```

Start (from repo root):
```
python tools/tasks/watch_assets.py
```

Behavior:
- Rebuilds tilesets with `tools/tilesetc.py` when `.tset` changes.
- Rebuilds levels with `tools/levelc.py` when `.lvl` changes.
- Tracks output mtimes to avoid unnecessary work.

Outputs:
- Same outputs as `tilesetc.py` and `levelc.py`.
- Cache file at `build/.asset_cache.json`.

---

## koala_tilekit_compiler.py

Builds a tileset + charset from a Koala image and a JSON spec.

Usage:
```
python tools/koala_tilekit_compiler.py images/BOOT_AUDIT1.json
```

Inputs:
- A `.kla` Koala image (same basename as the spec, unless `--kla` is set).
- A spec `.json` file.

Outputs (defaults, per spec name):
- `assets/<name>_chargen.bin`
- `levels/<name>.tset`
- `gen/analysis/<name>/<name>_tmap.bin`
- `gen/analysis/<name>/<name>_tile_locations.png`
- `gen/analysis/<name>/<name>_info.txt`
- `gen/analysis/<name>/tiles.md`

Notes:
- The spec drives tile names, flags, and object stamps.
- Use `--fast` to speed up MC color selection.

---

## tilesetc.py

Compiles a `.tset` tileset into a binary blob and C headers.

Usage:
```
python tools/tilesetc.py levels/BOOT_AUDIT1.tset -o assets/BOOT_AUDIT1.bin
```

Outputs:
- `gen/assets/<name>.bin`
- `gen/include/tilesets/<name>_tset_ids.h`
- `gen/include/tilesets/<name>_tset-blob.h`
- `gen/src/tilesets/<name>_tset.c`
- `gen/include/charset/<name>_charset-blob.h` (when `charset=` is set)
- `gen/src/charset/<name>_charset.c` (when `charset=` is set)
- `gen/analysis/tilesets/<name>.sym`
- `gen/analysis/tilesets/<name>.json`

See [docs/tset_format.md](tset_format.md) for format details.

---

## levelc.py

Compiles a `.lvl` level into a binary blob, C headers, and debug outputs.

Usage:
```
python tools/levelc.py levels/boot_audit.lvl
```

Outputs:
- `gen/assets/levels/<level>.bin`
- `gen/src/levels/<level>.c`
- `gen/include/levels/<level>.h`
- `gen/include/levels/<level>-blob.h`
- `gen/analysis/levels/<level>.sym`
- `gen/analysis/levels/<level>.json`

What it generates:
- `.bin` packed blob (maps, objects, scripts, messages).
- `.c` embedding the blob as `unsigned char[]` with `#embed`.
- `-blob.h` exposing the blob symbol + size.
- `<level>.h` with enums for flags/vars/items/messages and object types.
- `.sym` symbol map (offsets, rooms, objects, scripts, messages).
- `.json` debug summary (optional but generated by default).
- `level_format.h` only if `--format-h` is provided (the header is otherwise static in `include/`).

Input format summary:
```
LEVEL name="BOOT AUDIT" w=20 h=12 start=R0:S0 tset=boot_audit.tset

TILES
. FLOOR
# WALL
END

FLAGS
POWER_ON
END

VARS
RELAY_BITS
END

ITEMS
FUSE
END

MESSAGES
PANEL_OK = "PANEL: OK"
END

COND ALWAYS
  TRUE
END

ACT INSERT_FUSE
  SETFLAG POWER_ON
  MSG PANEL_OK
END

ROOM R0 name="Vestibule"
SPAWNS
  S0 2,7
END
EXITS
  R R1:S0
END
OBJECTS
  O1 at 5,5 type=HATCH_PANEL verbs=LOOK|USE cond=ALWAYS look=SHOW_PANEL fuse=INSERT_FUSE
END
MAP
####################
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
#..................#
####################
END
ENDROOM
```

Approach A routing (engine-coded, data-driven outcomes):
- `LOCKER_KEYPAD`: `code=` split into p0/p1, `ok=` -> alt0, `bad=` -> alt1.
- `BREAKER_PANEL`: `var=` -> p0, `expect=` -> p1, `ok=` -> alt0, `bad=` -> alt1.
- `HATCH_PANEL`: `fuse=` -> alt0, `badge=` -> alt1, `reject=` -> use (optional).

Common CLI options:
```
python tools/levelc.py levels/boot_audit.lvl \
  --out-assets gen/assets/levels \
  --out-src gen/src/levels \
  --out-include gen/include/levels \
  --out-debug gen/analysis/levels
```

Optional overrides:
- `--ids` write IDs header to a specific path.
- `--json` write debug JSON to a specific path.
- `--sym` write symbol map to a specific path.
- `--blob-c` / `--blob-h` write the blob C/header to a specific path.
- `--blob-name` override the C symbol name (default: `<level>_blob`).
- `--format-h` write `level_format.h` to a specific path.

Engine usage:
- `<level>_blob` provides the raw bytes.
- `level_format.h` provides offsets + helpers.
- `<level>.h` provides enums for flags/vars/items/messages.

See [docs/lvl_format.md](lvl_format.md) for format details.

---

## tools/tasks/build_assets.py

Builds a tileset and all levels in one pass.

Usage:
```
python tools/tasks/build_assets.py
python tools/tasks/build_assets.py --tset levels/BOOT_AUDIT1.tset
python tools/tasks/build_assets.py --levels levels
```

Inputs:
- One `.tset` file (default `levels/tileset.tset`).
- All `.lvl` files in the levels directory (default `levels/`).

Notes:
- If the default tileset path is missing and exactly one `.tset` exists in `levels/`, that file is used automatically.

Outputs:
- Tileset blob + headers via `tools/tilesetc.py`.
- Level blobs + headers via `tools/levelc.py`.

Notes:
- This does not compile the game binary. It only generates assets.
- It also refreshes `project-config.json` after generation so the build picks up new `gen/src` files.

---

## tools/tasks/gen_build.py

Expands `project-config.json` sources so VS64 can build directory/glob entries.

Usage:
```
python tools/tasks/gen_build.py
```

Inputs:
- `project-config.json`

Outputs:
- `project-config.json` with expanded `sources` (generated from `project-config.template.json`).

Notes:
- Use this before VS64 build/rebuild so `src/tilesets/` is expanded into the actual generated `.c` files.

---

## tset_parser.py (internal)

Shared parser for `.tset` used by `tilesetc.py` and `levelc.py`.
Not meant to be invoked directly.

---

## Common workflows

### Update tileset or charmap

1) Regenerate tileset assets (and optional charset):
```
python tools/tilesetc.py levels/BOOT_AUDIT1.tset -o gen/assets/BOOT_AUDIT1.bin
```

2) Rebuild levels that reference the tileset:
```
python tools/levelc.py levels/boot_audit.lvl
```

3) Expand sources for VS64 (so new tileset C files are linked):
```
python tools/tasks/gen_build.py
```

4) Build the PRG (VS64 rebuild or your CLI build command).

---

### Update level content

1) Compile the level:
```
python tools/levelc.py levels/boot_audit.lvl
```

2) Build the PRG.

---

### Rebuild everything (assets + levels)

```
python tools/tasks/build_assets.py --tset levels/BOOT_AUDIT1.tset --levels levels
python tools/tasks/gen_build.py
```

Then build the PRG.

---
